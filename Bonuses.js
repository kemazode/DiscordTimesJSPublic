/*
–§–∞–π–ª –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–æ–Ω—É—Å–æ–≤. 

–ö–∞–∂–¥—ã–π –±–æ–Ω—É—Å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç—ã, 
–≤ –∫–æ–Ω—Ü–µ —Ñ—É–Ω–∫—Ü–∏–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ (–≤—Å–µ–≥–¥–∞) –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é hit, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Å–æ–≤–æ–∫—É–ø–Ω–æ—Å—Ç—å
–∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —é–Ω–∏—Ç–∞ target:
* stage - —Å—Ç–∞–¥–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ –±–æ–Ω—É—Å–∞, 
	a) 'Attack' - –≤–æ –≤—Ä–µ–º—è –∞—Ç–∞–∫–∏ —é–Ω–∏—Ç–∞ —Å –±–æ–Ω—É—Å–æ–º
	–±) 'Defence' - –≤–æ –≤—Ä–µ–º—è –∞—Ç–∞–∫–∏ –Ω–∞ —é–Ω–∏—Ç–∞ —Å –±–æ–Ω—É—Å–æ–º
	–≥) 'Start' - –æ–¥–∏–Ω —Ä–∞–∑ –≤ –Ω–∞—á–∞–ª–µ –±–∏—Ç–≤—ã
	–¥) 'Ability' - –ø–æ–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–µ —Ç—Ä–æ–≥–∞—Ç—å

	stage –Ω—É–∂–µ–Ω –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞ –∫–∞–∫–æ–π —Å—Ç–∞–¥–∏–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—Å—è –±–æ–Ω—É—Å. –¢–∞–∫,
	—É –≤–∞–º–ø–∏—Ä–∞ –µ—Å—Ç—å —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤–ª–∏—è—é—â–∞—è –∫–∞–∫ –Ω–∞ –∞—Ç–∞–∫—É, —Ç–∞–∫ –∏ –Ω–∞ –∑–∞—â–∏—Ç—É, –ø–æ—ç—Ç–æ–º—É,
	—á—Ç–æ–±—ã –≤—ã–∑–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —ç—Ñ—Ñ–µ–∫—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –∞—Ç–∞–∫—É–µ—Ç –ª–∏ –æ–Ω –∏–ª–∏
	–∑–∞—â–∏—â–∞–µ—Ç—Å—è, –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é stage.

	–ï—Å–ª–∏ –±–æ–Ω—É—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–¥–Ω–æ–π —Å—Ç–∞–¥–∏–∏, –ø–∞—Ä–∞–º–µ—Ç—Ä —É—á–∏—Ç—ã–≤–∞—Ç—å –Ω–µ –Ω–∞–¥–æ.

* attacker - –Ω–æ–º–µ—Ä –∞—Ç–∞–∫—É—é—â–µ–≥–æ —é–Ω–∏—Ç–∞
* target - –Ω–æ–º–µ—Ä –∑–∞—â–∏—â–∞—é—â–µ–≥–æ—Å—è —é–Ω–∏—Ç–∞
* attacktype - —Ç–∏–ø –∞—Ç–∞–∫–∏, –ø—Ä–∏–º–µ–Ω—è–µ–º—ã–π –∞—Ç–∞–∫—É—é—â–∏–º —é–Ω–∏—Ç–æ–º (—Å–º. –º–∞—Å—Å–∏–≤—ã –≤–Ω–∏–∑—É)
* hit - –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ö–∞—Ä-–∫–∏ –∑–∞—â–∏—â–∞—é—â–µ–≥–æ —é–Ω–∏—Ç–∞ –ø–æ—Å–ª–µ –∞—Ç–∞–∫–∏

–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –æ—Ç—Ä—è–¥–∞–º–∏:

GetProperty(i, prop) - –ø–æ–ª—É—á–∏—Ç—å —Ö–∞—Ä-–∫—É prop —É —é–Ω–∏—Ç–∞ —Å –Ω–æ–º–µ—Ä–æ–º i. –ù–∞–∑–≤–∞–Ω–∏—è —Ö–∞—Ä-–∫
	—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ç–µ–º, —á—Ç–æ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ñ–∞–π–ª–µ Units.json.
	* i - –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è attacker –∏–ª–∏ target
	* prop - –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è "AttackBlow", "ProtectDeath", "Hits" –∏ —Ç. –¥.

SetState(i, name, emoji, frequency, f) - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è —é–Ω–∏—Ç–∞ —Å –Ω–æ–º–µ—Ä–æ–º i, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã:
	* i - –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è attacker –∏–ª–∏ target
	* name - –Ω–∞–∑–≤–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∞
	* emoji - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –ø–∞–Ω–µ–ª–∏ —é–Ω–∏—Ç–∞
	* frequency - —á–∞—Å—Ç–æ—Ç–∞ –æ–±–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è (–≤—ã–∑–æ–≤–∞ —Ñ—É–Ω–∫—Ü–∏–∏ f), –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è:
		–∞) 'each turn' - –∫–∞–∂–¥—ã–π –Ω–æ–≤—ã—Ö —Ö–æ–¥
		–±) 'each move' - –∫–∞–∂–¥—ã–π —Ö–æ–¥ (–º—É–≤) –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —é–Ω–∏—Ç–∞
	* f - —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–∞–∂–¥—ã–π —Ç—Ä–∏–≥–≥–µ—Ä, –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç unit (—Ö–∞—Ä-–∫–∏ —é–Ω–∏—Ç–∞) 

	–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ–Ω—É—Å–∞ —Å —Ñ—É–Ω–∫—Ü–∏–µ–π SetState –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ "–û—Ç—Ä–∞–≤–ª–µ–Ω–∏—è" –∞—Å—Å–∞—Å–∏–Ω–∞ (BonusPoison).

GoOff(move, attacker, target, attacktype) - –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –æ—Ç attacker –¥–ª—è target —Å 
	—Ç–∏–ø–æ–º –∞—Ç–∞–∫–∏ (–µ—Å–ª–∏ –æ–Ω–∞ –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç—Å—è) attacktype.
	* move - –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è 'Hit' (—É–¥–∞—Ä–∏—Ç—å), 'Pass' (–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ö–æ–¥)
	
	–° –ø–æ–º–æ—â—å—é —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –±–æ–Ω—É—Å—ã "–ü—Ä–æ–∫–ª—è—Ç–∏–µ —Å–º–µ—Ä—Ç–∏" (BonusGhost) –∏ "–ö–æ–Ω—Ç—Ä–∞—Ç–∞–∫–∞" (BonusCounterblow)


–¢–∞–∫ –∫–∞–∫ –±–æ–Ω—É—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–π —Å—Ç–∞–¥–∏–∏, –ø–µ—Ä–µ–¥ "–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π" —Ö–∞—Ä-–∫ —é–Ω–∏—Ç–æ–≤, –≤–ø–æ–ª–Ω–µ –≤–æ–∑–º–æ–∂–Ω–æ,
—á—Ç–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ö–∞—Ä-–∫–∏ –±—É–¥—É—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä —Ö–ø), –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ "—É–±–∏—Ç –ª–∏ —é–Ω–∏—Ç" –Ω–∞–¥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
–≤—ã—Ä–∞–∂–µ–Ω–∏–µ 'hits < 0', –∞ –Ω–µ 'hits === 0'.

–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –±–æ–Ω—É—Å—ã (—Å–º. BonusGhost –∏ BonusVampire)

–í –∫–æ–Ω—Ü–µ —Ñ—É–Ω–∫—Ü–∏–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ (–≤—Å–µ–≥–¥–∞) –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é hit, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Å–æ–≤–æ–∫—É–ø–Ω–æ—Å—Ç—å
–∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —é–Ω–∏—Ç–∞ target. 

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –±–æ–Ω—É—Å–∞, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –µ–≥–æ –≤–∫–ª—é—á–∏—Ç—å –≤ –∏–≥—Ä—É —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é (—Å–º. –≤–Ω–∏–∑—É)
CreateBonus(bonus, emoji, stage, callback), –≥–¥–µ
	* bonus - –Ω–∞–∑–≤–∞–Ω–∏–µ –±–æ–Ω—É—Å–∞
	* emoji - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–æ–Ω—É—Å–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ —é–Ω–∏—Ç–∞
	* stage - —Å—Ç–∞–¥–∏–∏ –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –±–æ–Ω—É—Å —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç—Å—è (–º–∞—Å—Å–∏–≤)
	* callback - —Ñ—É–Ω–∫—Ü–∏—è –±–æ–Ω—É—Å–∞

(–µ—Å–ª–∏ –≤—ã –°—É–ª—å—Ñ–æ–¥–∏–µ—Å, –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–∞–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –∏ —É–¥–∞–ª–∏—Ç–µ –ø–∞–ø–∫—É)
*/

const PhysicalAttacks =       ['Strike', 'Blow', 'Shot'];
const PhysicalDamageAttacks = ['Strike', 'Blow', 'Shot'];

const MagicAttacks =       ['Bless', 'Curse', 'Draining Life', 'Curse of Death', 'Heal'];
const MagicDamageAttacks = ['Draining Life'];

const DamageAttacks = [...PhysicalDamageAttacks, ...MagicDamageAttacks];


// Attack bonus: the character inflicts damage by ignoring the opponent's defences
function BonusArmorIgnore(stage, attacker, target, attacktype, hit) {
	blow = GetProperty(attacker, 'AttackBlow');
	shot = GetProperty(attacker, 'AttackShot');

	if (PhysicalDamageAttacks.includes(attacktype)) {
		if (blow !==  null) {
			hit.Hits = -blow;
		} else if (shot !== null) {
			hit.Hits = -shot;
		}
	}

	return hit;
}

// Start bonus: on the first turn in a battle, the character gets tripled protection
function BonusSpearDefence(stage, attacker, target, attacktype, hit) {
    defb = GetProperty(attacker, 'DefenceBlow');
	defs = GetProperty(attacker, 'DefenceBlow');

	return {'DefenceBlow': defb * 3, 'DefenceShot': defs * 3};
}

// Defence bonus: only 70% of the enemy's blows pass through the character's defence
// (only physical damage counts)
function BonusEvasive(stage, attacker, target, attacktype, hit) {
	if (PhysicalDamageAttacks.includes(attacktype)) {
		hit.Hits *= 0.7;
    }

	return hit;
}

// Start and attack bonus: the character always gets the very first move in a battle, 
// and deals damage while ignoring the opponent's defences
function BonusArtillery(stage, attacker, target, attacktype, hit) {
	if (stage === 'Start') {
		return { 'Initiative': 50 };

	} else {
		return BonusArmorIgnore(stage, attacker, target, attacktype, hit);
	}
}

// Attack bonus: the character inflicts 10 damage on top of his attack anyway, ignoring any enemy defences
function BonusGodAnger(stage, attacker, target, attacktype, hit) {
	if (DamageAttacks.includes(attacktype)) {
		hit.Hits = hit.Hits - 10;
	}

	return hit;
}

// Attack bonus: the character inflicts 20 damage on top of his attack anyway, ignoring any enemy defences
function BonusGodStrike(stage, attacker, target, attacktype, hit) {
	if (DamageAttacks.includes(attacktype)) {
		hit.Hits = hit.Hits - 20;
	}

	return hit;
}

// Start bonus: on the first turn in a battle the character receives +1 manoeuvre
function BonusHorseAttack(stage, attacker, target, attacktype, hit) {
	return { Manevres: 1 };
}


// Defence bonus: the character is dead and therefore the arrows cause 70% less damage
function BonusDead(stage, attacker, target, attacktype, hit) {
	if (attacktype === 'Shot' || attacktype === 'Strike') {
		hit.Hits *= 0.3;
	}

	return hit;
}

// Attack and defence bonus: the Evil force allows the character to 
// ignore enemy armour, and absorbs 30% of the enemy's impact
function BonusVampire(stage, attacker, target, attacktype, hit) {
	if (stage === 'Attack') {
		return BonusArmorIgnore(stage, attacker, target, attacktype, hit);
	} else {
		if (PhysicalDamageAttacks.includes(attacktype)) {
			hit.Hits *= 0.7;
		}
	}

	return hit;
}

// Attack, defence and start bonus: the Evil force allows the character to 
// ignore enemy armour, and absorbs 30% of the enemy's impact, while on the first
// turn of battle the character gains +1 manoeuvre
function BonusOldVampire(stage, attacker, target, attacktype, hit) {
	if (stage === 'Start') {
		return { Manevres: 1 };

	} else if (stage === 'Attack') {
		return BonusArmorIgnore(stage, attacker, target, attacktype, hit);
	} else {
		if (PhysicalDamageAttacks.includes(attacktype)) {
			hit.Hits *= 0.7;
		}
	}

	return hit;
}

// Defence bonus: the character is invulnerable to physical weapons,
// and if killed, his rage takes the life of his killer
function BonusGhost(stage, attacker, target, attacktype, hit) {
	targetHits = GetProperty(target, 'Hits');

	hit = BonusUnvulnerabe(stage, attacker, target, attacktype, hit);

	// Supposedly the hit haven't been normalized at this point, so we 
	// use '<' instead of '===' 
	if (targetHits + hit.Hits <= 0)  {
		GoOff('Hit', target, attacker, 'Banish');
	}
	return hit;
}

// Defence bonus: the character loses only 1 life hit from any hit
function BonusUnvulnerabe(stage, attacker, target, attacktype, hit) {
	if (PhysicalDamageAttacks.includes(attacktype)) {
		hit.Hits = -1;
	}

	return hit;
}

function BonusCounterblow(stage, attacker, target, attacktype, hit) {
	if (attacktype === 'Blow') {
		GoOff('Hit', target, attacker, 'Blow');
	}
	return hit;
}

// Under construction
function BonusGarrison(stage, attacker, target, attacktype, hit) {
	return hit;
}

function BonusPoison(stage, attacker, target, attacktype, hit) {
    if (stage === 'Attack') {
        SetState(target, 'Poisoned', 'ü§¢', 'each turn', function(unit) {
            unit.Hits = Math.round(unit.Hits - unit.InitialState.Hits * 0.15);
        });    
    } 
	return hit;
}

CreateBonus('ArmorIgnore',    'üó°Ô∏è', ['Attack'],                     BonusArmorIgnore);
CreateBonus('SpearDefense',   'üõ°Ô∏è', ['Start'],                      BonusSpearDefence);
CreateBonus('Evasive',        'üåÄ', ['Defence'],                    BonusEvasive);
CreateBonus('Artillery',      'üí•', ['Attack', 'Start'],            BonusArtillery);
CreateBonus('ArmyMedic',      '‚öïÔ∏è', ['Map'],                        null);
CreateBonus('GodAnger',       '‚ö°', ['Attack'],                     BonusGodAnger);
CreateBonus('GodStrike',      'üå©Ô∏è', ['Attack'],                     BonusGodStrike);
CreateBonus('HorseAttack',    'üèá', ['Start'],                      BonusHorseAttack);
CreateBonus('Dead',           '‚ò†Ô∏è', ['Defence'],                    BonusDead);
CreateBonus('FastDead',       '‚ò†Ô∏è', ['Defence'],                    BonusDead);
CreateBonus('VampirsGist',    'ü¶á', ['Attack', 'Defence'],          BonusVampire);
CreateBonus('OldVampirsGist', 'ü¶á', ['Attack', 'Defence', 'Start'], BonusOldVampire);
CreateBonus('Ghost',          'üëª', ['Defence'],                    BonusGhost);
CreateBonus('Unvulnerabe',    'üíÄ', ['Defence'],                    BonusUnvulnerabe);
CreateBonus('Counterblow',    '‚öîÔ∏è', ['Defence'],                    BonusCounterblow);
CreateBonus('Merchant',       'ü™ô', ['Map'],                        null);
CreateBonus('Garrison',       'üè∞', ['Ability'],                    BonusGarrison);
CreateBonus('Poison',         'üêç', ['Attack'],                     BonusPoison);